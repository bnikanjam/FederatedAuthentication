version: '3.8'

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      - DB_HOST=sql-server
      - DB_USER=sa
      - DB_PASSWORD=YourStrong!Passw0rd
      - DB_NAME=FederationDB
      - AUTH0_DOMAIN=${AUTH0_DOMAIN}
      - AUTH0_AUDIENCE=${AUTH0_AUDIENCE}
    depends_on:
      - sql-server
    networks:
      - federation-net

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "4200:80"
    depends_on:
      - backend
    networks:
      - federation-net

  sql-server:
    image: mcr.microsoft.com/azure-sql-edge
    ports:
      - "1433:1433"
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=YourStrong!Passw0rd
    networks:
      - federation-net
    volumes:
      - sql-data:/var/opt/mssql

  ldap-server:
    image: osixia/openldap:latest
    command: --copy-service
    ports:
      - "389:389"
      - "636:636"
    environment:
      - LDAP_ORGANISATION="My Company"
      - LDAP_DOMAIN="mycompany.com"
      - LDAP_ADMIN_PASSWORD=adminpassword
    networks:
      - federation-net
    volumes:
      - ldap-data:/var/lib/ldap
      - ldap-config:/etc/ldap/slapd.d

  phpldapadmin:
    image: osixia/phpldapadmin:latest
    ports:
      - "6443:443"
    environment:
      - PHPLDAPADMIN_LDAP_HOSTS=ldap-server
      - PHPLDAPADMIN_HTTPS=false
    depends_on:
      - ldap-server
    networks:
      - federation-net

networks:
  federation-net:
    driver: bridge

volumes:
  sql-data:
  ldap-data:
  ldap-config:
